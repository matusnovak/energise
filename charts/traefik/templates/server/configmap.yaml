{{- include "configmap-spec" (dict 
  "Values" .Values
  "Release" .Release
  "Chart" .Chart
  "component" "server") }}
data:
  "traefik.yml": |
    entryPoints:
      traefik:
        address: ":{{ .Values.traefik.server.port }}"
    {{- if .Values.traefik.server.http.enabled }}
      web:
        address: ":{{ .Values.traefik.server.http.port}}"
    {{- end }}
    {{- if  .Values.traefik.server.https.enabled }}
      websecure:
        address: ":{{ .Values.traefik.server.https.port}}"
    {{- end }}
    {{- if  .Values.traefik.server.accessLog.enabled }}
    accessLog: {}
    {{- end }}
    log:
      level: {{ .Values.traefik.server.log.level }}
    ping:
      entryPoint: traefik
    {{- if  .Values.traefik.server.dashboard.enabled }}
    api:
      dashboard: true
      insecure: true
    {{ end }}
    providers:
      kubernetesCRD:
        namespaces:
          - "{{ .Release.Namespace }}"
        allowCrossNamespace: false
    {{- if .Values.traefik.server.https.enabled }}
    {{- if eq .Values.traefik.server.certs.type "self-signed" }}
    tls:
      stores:
        default: {}
    {{- if and (.Values.traefik.server.certs.certFile) (.Values.traefik.server.certs.keyFile) }}
      certificates:
        - certFile: "/certs/{{ .Values.global.domain }}.cert"
          keyFile: "/certs/{{ .Values.global.domain }}.key"
          stores:
            - default
    {{- end }}
      domains:
        - main: "*.{{ .Values.global.domain }}"
          sans:
            - "{{ .Values.global.domain }}"
    {{- end }}
    {{- if eq .Values.traefik.server.certs.type "resolver" }}
    tls:
      stores:
        default: {}
      domains:
        - main: "*.{{ .Values.global.domain }}"
          sans:
            - "{{ .Values.global.domain }}"
      certresolver: "resolver"
    certificatesResolvers:
      resolver:
        acme:
          email: "{{ .Values.traefik.server.certs.email }}"
          storage: "/acme/acme.json"
          caServer: "{{ .Values.traefik.server.certs.server }}"
          certificatesDuration: {{ .Values.traefik.server.certs.duration }}
    {{- if eq .Values.traefik.server.certs.challenge "tls" }}
          tlsChallenge: {}
    {{- else if eq .Values.traefik.server.certs.challenge "http" }}
          httpChallenge:
            entryPoint: "web"
    {{- else if eq .Values.traefik.server.certs.challenge "dns" }}
          dnsChallenge:
            provider: "{{ .Values.traefik.server.certs.dnsProvider }}"
            resolvers:
              {{ toYaml .Values.traefik.server.certs.dnsResolvers | nindent 10 }}
    {{- end }}
    {{- end }}
    {{- end }}
    {{- if .Values.traefik.server.metrics.enabled }}
    metrics:
      prometheus:
        entryPoint: "traefik"
    {{- end }}
